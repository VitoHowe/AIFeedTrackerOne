# -*- coding: utf-8 -*-
"""
æ€»ç»“ç”Ÿæˆå™¨æ¨¡å—

ä½¿ç”¨AIå¤§æ¨¡å‹å’Œç²¾å¿ƒè®¾è®¡çš„æç¤ºè¯ç”Ÿæˆé«˜è´¨é‡çš„è§†é¢‘æ€»ç»“
"""

import logging
from typing import Optional

from .ai_client import AIClient


class SummaryGenerator:
    """è§†é¢‘æ€»ç»“ç”Ÿæˆå™¨"""

    # ç³»ç»Ÿæç¤ºè¯
    SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è§†é¢‘å†…å®¹æ€»ç»“åŠ©æ‰‹ï¼Œæ“…é•¿ä»è§†é¢‘å­—å¹•ä¸­æå–å…³é”®ä¿¡æ¯å¹¶ç”Ÿæˆç²¾ç¾çš„ç»“æ„åŒ–æ€»ç»“ã€‚

ä½ çš„æ€»ç»“éœ€è¦ï¼š
1. å‡†ç¡®æå–è§†é¢‘çš„æ ¸å¿ƒè§‚ç‚¹å’Œå…³é”®ä¿¡æ¯
2. ä½¿ç”¨æ¸…æ™°çš„Markdownæ ¼å¼ç»„ç»‡å†…å®¹
3. ä¿æŒå®¢è§‚ï¼Œä¸æ·»åŠ å­—å¹•ä¸­æ²¡æœ‰çš„å†…å®¹
4. è¯­è¨€ç®€æ´æµç•…ï¼Œé‡ç‚¹çªå‡º
5. ç”Ÿæˆæœ‰æ·±åº¦çš„æ€è€ƒé—®é¢˜å¼•å‘è¯»è€…æ€è€ƒ"""

    # ç”¨æˆ·æç¤ºè¯æ¨¡æ¿
    USER_PROMPT_TEMPLATE = """è¯·æ ¹æ®ä»¥ä¸‹è§†é¢‘å­—å¹•å†…å®¹ï¼Œç”Ÿæˆä¸€ä»½é«˜è´¨é‡çš„ç»“æ„åŒ–æ€»ç»“ï¼Œæ ¼å¼è¦æ±‚å¦‚ä¸‹ï¼š

## ğŸ“‹ æ ¼å¼è¦æ±‚

### 1. æ‘˜è¦ï¼ˆå¿…éœ€ï¼‰
ç”¨ä¸€æ®µè¯ï¼ˆ100-200å­—ï¼‰æ¦‚æ‹¬è§†é¢‘çš„æ ¸å¿ƒå†…å®¹å’Œä¸»è¦ä»·å€¼ã€‚

### 2. äº®ç‚¹ï¼ˆå¿…éœ€ï¼‰
- ä½¿ç”¨æ— åºåˆ—è¡¨ï¼ˆ- ğŸ’¡ï¼‰åˆ—å‡º6-8ä¸ªå…³é”®è¦ç‚¹
- æ¯ä¸ªè¦ç‚¹ä¸€å¥è¯ï¼Œç®€æ´æ˜ç¡®
- ä½¿ç”¨emojiå›¾æ ‡ï¼ˆğŸ’¡ ğŸ“ˆ ğŸ“‰ ğŸ”„ ğŸ¯ ğŸ“Š ç­‰ï¼‰å¢å¼ºå¯è¯»æ€§

### 3. æ ‡ç­¾ï¼ˆå¿…éœ€ï¼‰
ä½¿ç”¨ #æ ‡ç­¾å æ ¼å¼ï¼Œæå–3-5ä¸ªå…³é”®ä¸»é¢˜æ ‡ç­¾

### 4. æ€è€ƒï¼ˆå¿…éœ€ï¼‰
æå‡º2-3ä¸ªå¼•å‘æ·±åº¦æ€è€ƒçš„é—®é¢˜ï¼Œæ ¼å¼ï¼š
1. é—®é¢˜å†…å®¹...
2. é—®é¢˜å†…å®¹...

### 5. è§†é¢‘ç« èŠ‚æ€»ç»“ï¼ˆå¦‚æœèƒ½è¯†åˆ«å‡ºæ˜æ˜¾çš„ç« èŠ‚ç»“æ„ï¼‰
ä½¿ç”¨ä¸‰çº§æ ‡é¢˜ï¼ˆ###ï¼‰åˆ’åˆ†ç« èŠ‚ï¼Œæ¯ä¸ªç« èŠ‚åŒ…å«ï¼š
- ç« èŠ‚æ ‡é¢˜ï¼ˆåŒ…å«emojiå›¾æ ‡ï¼‰
- è¯¥éƒ¨åˆ†çš„æ ¸å¿ƒå†…å®¹æ€»ç»“ï¼ˆ2-3å¥è¯ï¼‰

## ğŸ“ è¾“å‡ºæ ¼å¼ç¤ºä¾‹

## æ‘˜è¦
ï¼ˆç”¨ä¸€æ®µè¯æ¦‚æ‹¬è§†é¢‘æ ¸å¿ƒå†…å®¹å’Œä»·å€¼ï¼‰

### äº®ç‚¹
- ğŸ’¡ è¦ç‚¹1ï¼šå†…å®¹...
- ğŸ“ˆ è¦ç‚¹2ï¼šå†…å®¹...
- ğŸ“‰ è¦ç‚¹3ï¼šå†…å®¹...
- ğŸ”„ è¦ç‚¹4ï¼šå†…å®¹...
- ğŸ¯ è¦ç‚¹5ï¼šå†…å®¹...
- ğŸ“Š è¦ç‚¹6ï¼šå†…å®¹...

#æ ‡ç­¾1 #æ ‡ç­¾2 #æ ‡ç­¾3

### æ€è€ƒ
1. æ€è€ƒé—®é¢˜1...
2. æ€è€ƒé—®é¢˜2...

## è§†é¢‘ç« èŠ‚æ€»ç»“

### ğŸ¤” ç« èŠ‚1æ ‡é¢˜
ç« èŠ‚1çš„æ ¸å¿ƒå†…å®¹æ€»ç»“...

### ğŸ“ˆ ç« èŠ‚2æ ‡é¢˜
ç« èŠ‚2çš„æ ¸å¿ƒå†…å®¹æ€»ç»“...

### ğŸ’¡ ç« èŠ‚3æ ‡é¢˜
ç« èŠ‚3çš„æ ¸å¿ƒå†…å®¹æ€»ç»“...

## âš ï¸ æ³¨æ„äº‹é¡¹
- ä¿æŒå®¢è§‚ï¼Œåªæå–å­—å¹•ä¸­çš„ä¿¡æ¯
- è¯­è¨€ç®€æ´æµç•…ï¼Œä¾¿äºé˜…è¯»
- å¦‚æœå­—å¹•å†…å®¹ä¸å¤Ÿä¸°å¯Œï¼Œå¯ä»¥é€‚å½“å‡å°‘ç« èŠ‚æ•°é‡
- æ ‡ç­¾è¦å‡†ç¡®åæ˜ è§†é¢‘ä¸»é¢˜
- æ€è€ƒé—®é¢˜è¦æœ‰æ·±åº¦ï¼Œèƒ½å¼•å‘è¿›ä¸€æ­¥çš„æ€è€ƒ

**è§†é¢‘å­—å¹•å†…å®¹ï¼š**
{subtitle}

è¯·å¼€å§‹æ€»ç»“ï¼š"""

    # å°çº¢ä¹¦å›¾ç‰‡åˆ†ææç¤ºè¯ï¼ˆåŸºé‡‘å¤§ V ä»Šæ—¥æ“ä½œåœºæ™¯ï¼‰
    XHS_IMAGE_PROMPT = """ä½ æ˜¯é¡¶çº§ä¸­å›½åŸºé‡‘æŠ•ç ”åŠ©ç†ï¼Œä»»åŠ¡æ˜¯æŠŠâ€œåŸºé‡‘å¤§ V ä»Šæ—¥æ“ä½œ/å¤ç›˜å›¾ç‰‡â€æ•´ç†æˆå¯æ‰§è¡Œçš„ç ”ç©¶æ‘˜è¦ã€‚

ç¡¬æ€§è§„åˆ™ï¼š
- åªèƒ½ä¾æ®å›¾ç‰‡å†…å®¹ä¸è¡¥å……ä¿¡æ¯ï¼Œä¸å¾—è‡†æµ‹ã€‚
- çœ‹ä¸æ¸…å°±å†™â€œæœªè¯†åˆ«/ç–‘ä¼¼â€ï¼Œä¸å…è®¸ç¼–é€ ã€‚
- è‹¥æä¾›â€œè¡¥å……ä¿¡æ¯/å†å²æ‘˜è¦â€ï¼Œè§†ä¸ºä¸Šä¸‹æ–‡èåˆï¼Œä¸è¦æåŠâ€œä¸Šæ–‡/æœ¬æ‰¹/è¡¥å……/æ”¶åˆ°/ä»¥ä¸‹æ˜¯â€ç­‰å­—æ ·ã€‚
- ç›´æ¥è¾“å‡ºç»“æœï¼Œä¸è¦è‡ªæˆ‘ä»‹ç»ï¼Œä¸è¦å¤è¿°æç¤ºè¯æˆ–è§„åˆ™ã€‚

è¾“å‡ºç»“æ„ï¼ˆå¿…é¡»æŒ‰é¡ºåºï¼‰ï¼š
## æ‘˜è¦
80-150 å­—æ¦‚æ‹¬å½“æ—¥ä¸»è¦æ“ä½œé€»è¾‘ã€å¸‚åœºæƒ…ç»ªä¸é£æ ¼ï¼ˆåé˜²å®ˆ/åè¿›æ”»ï¼‰ã€‚

## ä¹°å…¥ä¸»é¢˜ä¸ç†ç”±
- ä¸»é¢˜/è¡Œä¸š/èµ„äº§ç±»å‹ + ç®€è¦ç†ç”±ï¼ˆæ¯æ¡ 1 å¥è¯ï¼‰
- ä»…åˆ—å‡ºå›¾ç‰‡æ˜ç¡®å‡ºç°æˆ–å¯åˆç†æ¨æ–­çš„æ–¹å‘

## å–å‡º/å‡ä»“ä¸»é¢˜ä¸ç†ç”±
- ä¸»é¢˜/è¡Œä¸š/èµ„äº§ç±»å‹ + ç®€è¦ç†ç”±ï¼ˆæ¯æ¡ 1 å¥è¯ï¼‰
- ä»…åˆ—å‡ºå›¾ç‰‡æ˜ç¡®å‡ºç°æˆ–å¯åˆç†æ¨æ–­çš„æ–¹å‘

## é‡ç‚¹æ ‡çš„ä¸ä»“ä½å˜åŒ–
- æ ‡çš„åç§°ï¼ˆåŸºé‡‘/æŒ‡æ•°/ä¸ªè‚¡ï¼‰+ æ–¹å‘ï¼ˆä¹°å…¥/å–å‡º/åŠ ä»“/å‡ä»“ï¼‰
- ä¸ç¡®å®šè¯·æ ‡æ³¨â€œç–‘ä¼¼/å¯èƒ½â€

## ç­–ç•¥å¤ç›˜
1. äº¤æ˜“é€»è¾‘æ˜¯å¦ä¸å¸‚åœºç»“æ„åŒ¹é…ï¼ˆå¦‚é«˜ä½å…‘ç°/ä½ä½å¸ƒå±€/è½®åŠ¨ï¼‰
2. é£é™©ç‚¹ä¸å‰æå‡è®¾ï¼ˆå¦‚æƒ…ç»ªåè½¬/æ”¿ç­–å˜åŒ–/èµ„é‡‘é¢ï¼‰

## æ¨èæ¿å—ä¸åŸºé‡‘
- æ¿å—ï¼šä»…åŸºäºå›¾ç‰‡å‡ºç°çš„ä¸»çº¿ï¼Œç»™å‡º 1-3 ä¸ªå¯å…³æ³¨æ¿å—
- åŸºé‡‘ï¼šä»…åœ¨å›¾ç‰‡æ˜ç¡®å‡ºç°åŸºé‡‘åç§°/ä»£ç æ—¶ç»™å‡ºâ€œæ¨èåŸºé‡‘â€ï¼›å¦åˆ™å†™â€œæœªè¯†åˆ«å…·ä½“åŸºé‡‘åç§°ï¼Œå»ºè®®å…³æ³¨å¯¹åº”æ¿å—æŒ‡æ•°åŸºé‡‘/ETFâ€

## é£é™©æç¤º
å¼ºè°ƒä¿¡æ¯ä¸å®Œæ•´ã€ä»…ä¾›ç ”ç©¶ï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚

è¾“å‡ºè¦æ±‚ï¼šä¸­æ–‡ï¼Œç®€æ´æ˜ç¡®ï¼Œé‡ç‚¹çªå‡ºï¼Œé¿å…ç¼–é€ ã€‚"""

    def __init__(self, ai_client: AIClient):
        """
        åˆå§‹åŒ–æ€»ç»“ç”Ÿæˆå™¨

        Args:
            ai_client: AIå®¢æˆ·ç«¯å®ä¾‹
        """
        self.ai_client = ai_client
        self.logger = logging.getLogger(f"{__name__}.{self.__class__.__name__}")

    async def generate_summary(self, subtitle: str) -> Optional[str]:
        """
        ç”Ÿæˆè§†é¢‘æ€»ç»“

        Args:
            subtitle: è§†é¢‘å­—å¹•æ–‡æœ¬

        Returns:
            Markdownæ ¼å¼çš„æ€»ç»“å†…å®¹ï¼Œå¤±è´¥è¿”å›None
        """
        try:
            if not subtitle or len(subtitle.strip()) < 50:
                self.logger.error("å­—å¹•å†…å®¹å¤ªçŸ­ï¼Œæ— æ³•ç”Ÿæˆæ€»ç»“")
                return None

            self.logger.info(f"å¼€å§‹ç”Ÿæˆæ€»ç»“ï¼Œå­—å¹•é•¿åº¦: {len(subtitle)} å­—ç¬¦")

            # å¦‚æœå­—å¹•å¤ªé•¿ï¼Œéœ€è¦æˆªæ–­ï¼ˆé˜²æ­¢è¶…è¿‡tokené™åˆ¶ï¼‰
            max_subtitle_length = 30000  # çº¦10000ä¸ªtoken
            if len(subtitle) > max_subtitle_length:
                self.logger.warning(
                    f"å­—å¹•è¿‡é•¿ï¼ˆ{len(subtitle)}å­—ç¬¦ï¼‰ï¼Œå°†æˆªæ–­åˆ°{max_subtitle_length}å­—ç¬¦"
                )
                subtitle = (
                    subtitle[:max_subtitle_length] + "...\n[å­—å¹•å› é•¿åº¦é™åˆ¶å·²æˆªæ–­]"
                )

            # æ„å»ºæç¤ºè¯
            user_prompt = self.USER_PROMPT_TEMPLATE.format(subtitle=subtitle)

            # æ„å»ºæ¶ˆæ¯
            messages = [
                {"role": "system", "content": self.SYSTEM_PROMPT},
                {"role": "user", "content": user_prompt},
            ]

            # è°ƒç”¨AI
            summary = await self.ai_client.chat_completion(
                messages=messages,
                temperature=0.7,  # é€‚ä¸­çš„åˆ›é€ æ€§
                max_tokens=3000,  # å¢åŠ è¾“å‡ºé•¿åº¦ä»¥æ”¯æŒæ›´è¯¦ç»†çš„æ€»ç»“
            )

            if summary:
                self.logger.info(f"æ€»ç»“ç”ŸæˆæˆåŠŸï¼Œé•¿åº¦: {len(summary)} å­—ç¬¦")
                return summary
            else:
                self.logger.error("AIè¿”å›çš„æ€»ç»“ä¸ºç©º")
                return None

        except Exception as e:
            self.logger.error(f"ç”Ÿæˆæ€»ç»“å¤±è´¥: {e}", exc_info=True)
            return None

    async def generate_short_summary(self, subtitle: str) -> Optional[str]:
        """
        ç”Ÿæˆç®€çŸ­æ€»ç»“ï¼ˆç”¨äºå¿«é€Ÿé¢„è§ˆï¼‰

        Args:
            subtitle: è§†é¢‘å­—å¹•æ–‡æœ¬

        Returns:
            ç®€çŸ­æ€»ç»“ï¼ˆ100-200å­—ï¼‰ï¼Œå¤±è´¥è¿”å›None
        """
        try:
            if not subtitle or len(subtitle.strip()) < 50:
                self.logger.error("å­—å¹•å†…å®¹å¤ªçŸ­ï¼Œæ— æ³•ç”Ÿæˆæ€»ç»“")
                return None

            # ç®€çŸ­æ€»ç»“çš„æç¤ºè¯
            short_prompt = f"""è¯·ç”¨ä¸€æ®µè¯ï¼ˆ100-200å­—ï¼‰æ€»ç»“ä»¥ä¸‹è§†é¢‘çš„æ ¸å¿ƒå†…å®¹ï¼š

{subtitle[:5000]}

æ€»ç»“ï¼š"""

            messages = [
                {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å†…å®¹æ€»ç»“åŠ©æ‰‹ã€‚"},
                {"role": "user", "content": short_prompt},
            ]

            summary = await self.ai_client.chat_completion(
                messages=messages,
                temperature=0.5,
                max_tokens=300,
            )

            return summary

        except Exception as e:
            self.logger.error(f"ç”Ÿæˆç®€çŸ­æ€»ç»“å¤±è´¥: {e}")
            return None
